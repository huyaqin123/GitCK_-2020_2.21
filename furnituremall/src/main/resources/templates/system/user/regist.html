<!DOCTYPE html>
<html  class="loginHtml" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<title>进销存系统-注册</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="icon" href="/resource/favicon.ico">
	<link rel="stylesheet" href="/resource/layui/css/layui.css" media="all" />
	<link rel="stylesheet" href="/resource/css/public.css" media="all" />
</head>
<body class="loginBody">
	<form class="layui-form" style="height: 430px">
		<div class="login_face"><img src="/resource/images/face.jpg" class="userAvatar"></div>
		<div class="layui-form-item input-item">
			<label for="phone">手机号</label>
			<input type="text" placeholder="请输入手机号" autocomplete="off" id="phone" name="phone" class="layui-input" lay-verify="required">
		</div>
		<div class="layui-form-item input-item">
			<div class="layui-row">
				<div class="layui-col-xs7">
					<label for="code">验证码</label>
					<input name="code" id="code" autocomplete="off" class="layui-input" type="text" placeholder="验证码" lay-verify="required">
				</div>
				<div class="layui-col-xs5">
					<div style="margin-left: 10px;">
						<button class="layui-btn layui-btn-primary layui-btn-fluid" id="sendBtn" type="button">获取验证码</button>
					</div>
				</div>
			</div>
		</div>
		<div class="layui-form-item input-item">
			<label for="userNamee">店铺名称</label>
			<input type="text" placeholder="请输店铺名称" autocomplete="off" id="userNamee" name="userNamee" class="layui-input" lay-verify="required">
		</div>
		<div class="layui-form-item input-item">
			<label for="password">密码</label>
			<input type="password" placeholder="请输入密码" autocomplete="off" id="password" name="password" class="layui-input" lay-verify="required">
		</div>
		<div class="layui-form-item input-item">
			<label for="password">重复密码</label>
			<input type="password" placeholder="请再次输入密码" autocomplete="off" id="rpass" name="rpass" class="layui-input" lay-verify="required">
		</div>
		<div class="layui-form-item">
			<button type="submit" class="layui-btn layui-block" lay-submit lay-filter="doSubmit">注册</button>
		</div>
		<div class="layui-form-item layui-row" style="margin-top: 15px">
			<a href="/system/login" style="margin-left: 150px">用已有帐号登入</a>
		</div>
	</form>
	<script type="text/javascript" src="/resource/layui/layui.js"></script>
	<script type="text/javascript" src="/resource/js/cache.js"></script>
	<script>
		layui.config({
			base: '/resource/js/'
		}).use(['form','jquery','element','layer'],function () {
			var form = layui.form;
			var $=layui.jquery;
			var element=layui.element;
			var layer = parent.layer === undefined ? layui.layer : top.layer
			$ = layui.jquery;

			$(".loginBody .seraph").click(function(){
				layer.msg("这只是做个样式，至于功能，你见过哪个后台能这样登录的？还是老老实实的找管理员去注册吧",{
					time:5000
				});
			})
			var flag;
			//登录按钮
			form.on("submit(doSubmit)",function(data){
				//通过ajax的post提交
				if (flag){
					$.post("/system/user/checkPhone",{"phone":$("#phone").val()},function (result) {
						if (result){
							$.post("/system/user/checkCode",{"code":$("#code").val()},function (result) {
								if (result){
									$.post("/system/user/regist",data.field,function (result) {
										if (result.success) {
											layer.msg("注册成功！！！即将跳转到登录页面...", {time: 5000, icon: 1});
											var time = 5;
											setInterval(function () {
												if (time == 0) {
													location.href = "/login";
												}
												time--;
											}, 1000)
											return;
										}
										layer.msg(result.message, {time: 5000, icon: 2});
									},"json")
								}else {
									layer.msg("验证码输入有误，请重新输入", {icon: 2});
								}
							},"json");
						}else {
							layer.msg("手机号与验证码不匹配，请重新输入手机号",{icon:0});
						}
					},"json");
				}else {
					layer.msg("手机号码已被注册",{icon:0});
				}
				return false;
			});

			//邮箱失去焦点验证
			$("#phone").blur(function () {
				//验证邮箱规则
				var  reg = /^1[3456789]\d{9}$/;
				var phone = $(this).val().trim();//邮箱
				if(phone.length==0){
					flag = false;//验证失败
				}else if(!reg.test(phone)){
					flag = false;//验证失败
					layer.tips("手机号有误，请重新输入","#phone",{time:0,tips: [2, '#FF3300']});
				}else{
					//验证邮箱是否可用
					$.post("/system/user/checkPhone",{"phone":phone},function(result){
						if(result.exist){
							//提示用户邮箱已注册
							layer.tips(result.message, '#phone',{time:0, tips: [2, '#FF3300']});
							flag = false;//验证失败
						}else{
							//提示邮箱可用
							layer.tips(result.message, '#phone',{time:0, tips: [2, '#00CC00']});
							flag = true;//验证通过
						}
					},"json");
				}
			});
			/**
			 * 短信60秒倒计时
			 */
			$("#sendBtn").click(function () {
				if ($("#phone").val()!='') {
					if (flag){
						$.post("/find/code", {"memPhone": $("#phone").val()})
						var $button = $("#sendBtn");
						var number = 60;
						var countdown = function () {
							if (number == 0) {
								$button.attr("disabled", false);
								$button.html("发送验证码");
								number = 60;
								return;
							} else {
								$button.attr("disabled", true);
								$button.html(number);
								number--;
							}
							setTimeout(countdown, 1000);
						}
						setTimeout(countdown, 1000);
						layer.msg("短信发送成功，请注意查收！！", {icon: 1});
					}else{
						layer.msg("手机号码已被注册,无法发送验证码",{icon:0});
					}
				}else{
					layer.msg("请先输入手机号",{icon:2});
				}
			});

			//表单输入效果
			$(".loginBody .input-item").click(function(e){
				e.stopPropagation();
				$(this).addClass("layui-input-focus").find(".layui-input").focus();
			})
			$(".loginBody .layui-form-item .layui-input").focus(function(){
				$(this).parent().addClass("layui-input-focus");
			})
			$(".loginBody .layui-form-item .layui-input").blur(function(){
				$(this).parent().removeClass("layui-input-focus");
				if($(this).val() != ''){
					$(this).parent().addClass("layui-input-active");
				}else{
					$(this).parent().removeClass("layui-input-active");
				}
			})
			//表单验证
			form.verify({
				phone: function(value, item){ //value：表单的值、item：表单的DOM对象
					if(!(/^1[3456789]\d{9}$/.test(value))){
						return '手机号有误,请重新填';
					}
				}
				,password: [
					/^[\S]{6,20}$/
					,'密码必须6到20位，且不能出现空格'
				]
				,rpass:function (value,item) {
					//判断两次密码是否一致
					if (value!=$("#password").val().trim()){
						return "两次密码不一致";
					}
				}
			});
		})

	</script>
</body>
</html>