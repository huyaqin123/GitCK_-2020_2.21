<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>家居商城-注册</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/resource/layui/css/layui.css">
    <link rel="stylesheet" href="/resource/css/index.css">
</head>
<body>
<div th:replace="mall/common/head::mall_head"></div>
<div class="layui-fulid" id="house-login">
    <div class="layui-form" style="height: 500px;">
        <form method="post" id="regFrm" lay-filter="regFrm">
        <p>注册</p>
        <div class="layui-input-block login">
            <i class="layui-icon layui-icon-house-mobile"></i>
            <input type="text" for="phone" name="phone" id="phone" required lay-verify="required|phone" placeholder="请输入手机号" class="layui-input">
        </div>
        <div class="layui-input-block login">
            <i class="layui-icon">&#xe667;</i>
            <input type="password" name="password" id="password" required lay-verify="required|password" placeholder="请输入密码" class="layui-input">
            <!--            <button class="layui-btn">获取验证码</button>-->
        </div>
        <div class="layui-input-block login">
            <i class="layui-icon">&#xe667;</i>
            <input type="password" name="repass" required lay-verify="required|password|repass" placeholder="请输入确认密码" class="layui-input">
            <!--            <button class="layui-btn">获取验证码</button>-->
        </div>
        <div class="layui-input-block getCode">
            <input type="text" name="code" id="code" required lay-verify="required" placeholder="请输入短信验证码" class="layui-input">
            <button class="layui-btn" id="sendBtn" type="button">获取验证码</button>
        </div>
        <button class="layui-btn" lay-submit lay-filter="doSubmit">注册</button>
        </form>
    </div>
</div>
<div th:replace="mall/common/foot::mall_foot"></div>
<script src="/resource/layui/layui.js"></script>
<script>
    layui.config({
        base: '/resource/js/'
    }).use(['form','jquery','element','layer'],function () {
        var form = layui.form;
        var $=layui.jquery;
        var element=layui.element;
        var layer=layui.layer;

        //表单验证
        form.verify({
            phone: function(value, item){ //value：表单的值、item：表单的DOM对象
                if(!(/^1[3456789]\d{9}$/.test(value))){
                    return '手机号有误,请重新填';
                }
            }
            ,password: [
                /^[\S]{6,20}$/
                ,'密码必须6到20位，且不能出现空格'
            ]
            ,repass:function (value,item) {
                //判断两次密码是否一致
                if (value!=$("#password").val().trim()){
                    return "两次密码不一致";
                }
            }
        });

        //表单提交
        form.on("submit(doSubmit)",function (data) {
            if (flag) {
                $.post("/user/sendPhone", {"phone": $("#phone").val()}, function (result) {
                    if (result){
                        $.post("/user/checkCode", {"code": $("#code").val()}, function (result) {
                            if (result) {
                                $.post("/user/regist", data.field, function (result) {
                                    if (result.success) {
                                        layer.msg("注册成功！！！即将跳转到登录页面...", {time: 5000, icon: 1});
                                        var time = 5;
                                        setInterval(function () {
                                            if (time == 0) {
                                                location.href = "/login";
                                            }
                                            time--;
                                        }, 1000)
                                        return;
                                    }
                                    layer.msg(result.message, {time: 5000, icon: 2});
                                }, "json");
                            } else {
                                layer.msg("验证码输入有误，请重新输入", {icon: 2});
                            }
                        },"json");
                    }else{
                        layer.msg("手机号与验证码不匹配，请重新输入手机号",{icon:0});
                    }
                },"json")

            }else {
                layer.msg("手机号码已被注册",{icon:0});
            }
            return false;
        });

        var flag;
        //邮箱失去焦点验证
        $("#phone").blur(function () {
            //验证邮箱规则
            var  reg = /^1[3456789]\d{9}$/;
            var phone = $(this).val().trim();//邮箱
            if(phone.length==0){
                flag = false;//验证失败
            }else if(!reg.test(phone)){
                flag = false;//验证失败
                layer.tips("手机号有误，请重新输入","#phone",{time:0,tips: [2, '#FF3300']});
            }else{
                //验证邮箱是否可用
                $.post("/user/checkPhone",{"phone":phone},function(result){
                    if(result.exist){
                        //提示用户邮箱已注册
                        layer.tips(result.message, '#phone',{time:0, tips: [2, '#FF3300']});
                        flag = false;//验证失败
                    }else{
                        //提示邮箱可用
                        layer.tips(result.message, '#phone',{time:0, tips: [2, '#00CC00']});
                        flag = true;//验证通过
                    }
                },"json");
            }
        });
        /**
         * 短信60秒倒计时
         */
        $("#sendBtn").click(function () {
            if ($("#phone").val()!='') {
                if (flag){
                    $.post("/find/code", {"memPhone": $("#phone").val()})
                    var $button = $("#sendBtn");
                    var number = 60;
                    var countdown = function () {
                        if (number == 0) {
                            $button.attr("disabled", false);
                            $button.html("发送验证码");
                            number = 60;
                            return;
                        } else {
                            $button.attr("disabled", true);
                            $button.html(number);
                            number--;
                        }
                        setTimeout(countdown, 1000);
                    }
                    setTimeout(countdown, 1000);
                    layer.msg("短信发送成功，请注意查收！！", {icon: 1});
                }else{
                    layer.msg("手机号码已被注册,无法发送验证码",{icon:0});
                }
            }else{
                layer.msg("请先输入手机号",{icon:2});
            }
        });
    });
</script>
</body>
</html>